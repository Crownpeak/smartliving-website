$CMS_SET(set_videoId, st_youtubeVideo.values.first.id)$
$CMS_SET(set_autoplay, if(!st_autoPlay.isEmpty() && st_autoPlay, "data-youtube-autoplay",""))$
$CMS_SET(set_isInteractive, if(!st_videoElements.isEmpty(), true, false))$
$CMS_SET(set_hasContent, set_isInteractive || !st_text.isEmpty())$
<section class="py-14" $CMS_VALUE(editorId(reloadPreview:true))$>
	<div class="container px-4 mx-auto">
		$CMS_RENDER(template:"render_headline", prm_headline: st_headline, 
					prm_defaultTag: "h2", 
					prm_cssClasses: "mb-8 text-3xl md:text-4xl font-bold font-heading tracking-px-n leading-none text-primary" + if(!set_hasContent, " text-center"),
					prm_inputComponentName: "st_headline")$
		<div
			class="flex flex-wrap $CMS_VALUE(if(set_hasContent, "lg:grid lg:grid-cols-2 lg:grid-flow-col-denselg: gap-8 lg:pt-12 xl:-m-10"
																, "md:max-w-4xl mx-auto text-center"))$"
			data-youtube-video-id="$CMS_VALUE(set_videoId, default: "")$"
			$CMS_VALUE(set_autoplay)$
			$CMS_VALUE(if(set_isInteractive, "data-youtube-is-interactive"))$
			$CMS_VALUE(if(st_loopVideo, "data-youtube-loop-video"))$
			data-youtube-muted
			data-youtube-nocookie
		>
			<div class="w-full $CMS_VALUE(if(set_hasContent, "lg:row-span-2"))$">
				<div class="mx-auto h-full" $CMS_VALUE(editorId(editorName:"st_youtubeVideo"))$>
					<iframe
						class="w-full rounded-3xl $CMS_VALUE(if(set_hasContent, "min-h-[320px] md:min-h-[400px] lg:min-h-[320px] xl:min-h-[400px]",
																				"min-h-[320px] md:min-h-[504px]"))$"
					></iframe>
				</div>
			</div>
			$CMS_IF(set_hasContent)$
				<div class="w-full order-first lg:order-none lg:row-span-1" $CMS_VALUE(editorId(editorName:"st_text"))$>
					$CMS_VALUE(st_text, default:"")$
				</div>			
				<div class="w-full lg:row-span-1">							
					<div class="w-full flex mb-6 justify-center youtube-bullets"></div>
					<!-- Transition fade in out -->
					<div class="relative w-full min-h-[300px] overflow-hidden youtube-container">					
						$CMS_VALUE(st_videoElements)$
					</div>
				</div>
			$CMS_END_IF$
		</div>
	</div>
</section>
$CMS_SET(set_script)$
	<script>
		window.addEventListener(
			"DOMContentLoaded",
			(event) => {
				const appendTo = (targetElement, newTag, attributes) =>
					Object.assign(targetElement.appendChild(document.createElement(newTag)), attributes);
	
				const getYouTubePlayer = (iframe) => {
					const YT_API_URL = "https://www.youtube.com/iframe_api";
					document.querySelector(`script[src="${YT_API_URL}"]`) ||
						appendTo(document.body, "script", { src: YT_API_URL });
	
					return new Promise((resolve) => {
						(function check() {
							window.YT && YT.loaded
								? new YT.Player(iframe, { events: { onReady: ({ target }) => resolve(target) } })
								: window.setTimeout(check, 10);
						})();
					});
				};
	
				const removeClassByPrefix = (node, prefix) => {
					var regx = new RegExp("\\b" + prefix + "[^ ]*[ ]?\\b", "g");
					node.className = node.className.replace(regx, "");
					return node;
				};
	
				const __item = Symbol();
	
				class FsYoutubePlayer {
					constructor(youtubePlayer) {
						this.youtubePlayer = youtubePlayer;
					}
					init() {
						if (!this.videoId) throw new Error("Missing video-id attribute on fs-youtube-player.");
	
						if(this.isInteractive){
							let containerHeight = 0;
							let youtubeBullets = this.querySelect(".youtube-bullets");
							youtubeBullets.replaceChildren();
							this.items = Array.from(this.youtubePlayer.querySelectorAll("[data-youtube-time]"))
								.map((node) => ({ node, time: +node.dataset.youtubeTime }))
								.map((item, i, arr) => {
									const match =
										i + 1 === arr.length
											? (t) => t >= arr[i].time
											: (t) => t >= arr[i].time && t < arr[i + 1].time;
									Object.assign(item, { match });
									item.indx = i;
									item.node[__item] = item;
									item.node.style.transform = `translateX(${i * 100}%)`;
									item.bullet = appendTo(youtubeBullets, "button", {});
									item.bullet.classList.add(
										"w-20",
										"h-1.5",
										"m-2",
										"rounded-full",								
										"transition-colors",
										"duration-100",
										"ease-out",
										"bg-secondary",
										"hover:brightness-90",
										"hover:shadow-lg"
									);
									this.addEvent(item.node, "click", () => this.show(item.indx));
									this.addEvent(item.bullet, "click", () => this.goTo(item.node));
									containerHeight < item.node.offsetHeight && (containerHeight = item.node.offsetHeight);
									return item;
								});
							
							let youtubeContainer = this.querySelect(".youtube-container");
							youtubeContainer.style.height = containerHeight + "px";
		
							this.addEvent(youtubeContainer, "mouseenter", () => (this[__item] = false));
							this.addEvent(youtubeContainer, "touchstart", () => (this[__item] = false));
							this.addEvent(youtubeContainer, "mouseleave", () => delete this[__item]);						
						}
	
						let url = new URL(`https://www.youtube.com/embed/${this.videoId}?`);
						this.nocookie && (url.hostname = "www.youtube-nocookie.com");
	
						url.searchParams.set("rel", 0);	
						url.searchParams.set("enablejsapi", 1);
						url.searchParams.set("origin", location.origin);
						url.searchParams.set("playlist", this.videoId);
						url.searchParams.set("loop", ((this.loopVideo) ? 1 : 0));						
						let iframe = this.querySelect("iframe");
						iframe.src = url.toString();
						getYouTubePlayer(iframe)
							.then((player) => {
								this.player = player;								
								this.muted && player.mute();				
								
								if(this.isInteractive){
									window.setInterval(() => {
										const time = this.player.getCurrentTime();
										if (time !== this.__time && this[__item] !== false) {
											this.__time = time;
											const item = this.items.find(({ match }) => match(this.__time)) || this.items[0];
											if (this[__item]) {
												if (item !== this[__item]) {
													this[__item] = item;
													this.show(item.indx);
												}
											} else {
												(this[__item] = item) && this.show(item.indx);
											}
										}
									}, 30);
								}
								if(this.autoplay){
									const observer = new IntersectionObserver((entries, observer) => {
									  entries.forEach((entry) => {
									    console.log(entry.intersectionRatio > 0 ? "visible" : "invisible");
									    if(entry.intersectionRatio > 0 
									    	&& ((player.getPlayerState() < 0) || (3 < player.getPlayerState()))){
									    	 player.playVideo();
									   	}
									  });
									}, { threshold: 1.0});
									observer.observe(iframe);					
								}
							})
							.catch((e) => {
								console.log(e);
							});
						
					}
					querySelect(selectors) {
						return this.youtubePlayer.querySelector(selectors);
					}
					addEvent(selectors, eventName, handlerFn) {
						(typeof selectors === "string" ? this.querySelect(selectors) : selectors).addEventListener(
							eventName,
							handlerFn
						);
					}
					show(itemIndex) {
						this.items.forEach((item, indx) => {
							item.node.style.transform = `translateX(${100 * (indx - itemIndex)}%)`;
							if (indx === itemIndex) {
								item.bullet.classList.add("bg-secondary");
								item.bullet.classList.remove("bg-coolGray-400");
							} else {
								item.bullet.classList.add("bg-coolGray-400");
								item.bullet.classList.remove("bg-secondary");
							}
						});
					}
					goTo(node) {
						__item in this && delete this[__item];
						const timeEl = node.closest("[data-youtube-time]");
						if (timeEl && this.player) this.player.seekTo(+timeEl.dataset.youtubeTime, true);
					}
					get videoId() {
						return this.youtubePlayer.dataset.youtubeVideoId;
					}
					get autoplay() {
						return this.youtubePlayer.hasAttribute("data-youtube-autoplay");
					}
					get loopVideo() {
						return this.youtubePlayer.hasAttribute("data-youtube-loop-video");
					}
					get muted() {
						return this.youtubePlayer.hasAttribute("data-youtube-muted");
					}
					get nocookie() {
						return this.youtubePlayer.hasAttribute("data-youtube-nocookie");
					}
					get fullscreen() {
						return this.youtubePlayer.hasAttribute("data-youtube-fullscreen");
					}
					get isInteractive() {
						return this.youtubePlayer.hasAttribute("data-youtube-is-interactive");
					}
				}
				let youtubePlayer = document.querySelectorAll("[data-youtube-video-id]");
				youtubePlayer.forEach((element) => {
					new FsYoutubePlayer(element).init();
				});		
			},
			{ once: true }
		);
	</script>
$CMS_END_SET$
$CMS_RENDER(template: "javascript_collector", prm_action: "add", 
												prm_jSStatement: set_script, 
												prm_jSId: #this.template.uid)$
